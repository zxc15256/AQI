<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>m.AQI</title>

    <!-- css -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/weather-icons.css">
    <link rel="stylesheet" href="css/weather-icons-wind.css">

    <!--icon-->
    <link rel="shortcut icon" sizes="16x16 32x32  64x64 128x128" href="http://mokokai.tk/OpenWeatherSide/img/sunset.ico">

    <!-- Bootstrap -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-1.9.1.js"></script>
    <script src='https://mokokai.tk/OpenWeatherSide/js/changeBackground.js'></script>
    <script src='https://mokokai.tk/OpenWeatherSide/js/backtohome.js'></script>
    <script src="https://webduino.io/components/webduino-js/dist/webduino-all.min.js"></script>
    <script src="https://blockly.webduino.io/webduino-blockly.js"></script>
    <script src="https://blockly.webduino.io/lib/firebase.js"></script>
    <script src="https://blockly.webduino.io/lib/runtime.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.1.3/firebase.js"></script>

    <script>
        var data = [];
        var today, y, mo, d, t, h, m, s;
        var sel_index, sel_value;
        //變數 
        var rgbled;
        var result = [];
        var resultAQI;
        //Location
        var mCountry;
        var mCity;
        var mCity2;
        var region;
        var lining;
        //wind
        var chill;
        var direction;
        var speed;
        //Atmosphere
        var humidity;
        var pressure;
        var rising;
        var visibility;
        //Astronomy
        var sunrise;
        var sunset;
        //Condition
        var date;
        var day;
        var high;
        var low;
        var temp;
        var code;
        var pushTime;
        var publish_time;
        var url2 = '';
        var alreadyspeech2 = false;

        function gettime() {
            //date
            today = new Date();
            y = today.getFullYear();
            mo = today.getMonth() + 1;
            d = today.getDate();
            t = new Date();
            h = "0" + t.getHours();
            m = "0" + t.getMinutes();
            s = "0" + t.getSeconds();
            h = h.substring(h.length - 2, h.length + 1);
            m = m.substring(m.length - 2, m.length + 1);
            s = s.substring(s.length - 2, s.length + 1);
        }

        //語音辨識用
        var city = {
            1: "基隆",
            2: "台北",
            3: "新北",
            4: "桃園",
            5: "新竹",
            6: "苗栗",
            7: "台中",
            8: "南投",
            9: "彰化",
            10: "雲林",
            11: "嘉義",
            12: "台南",
            13: "高雄",
            14: "屏東",
            15: "Taitung",
            16: "花蓮",
            17: "宜蘭",
            18: "金門",
            19: '澎湖',
            20: "連江"
        };
        //抓資料需要用經緯度
        var citygps = {
            1: '25.1240262,121.6470147',
            2: '25.0169639,121.2261862',
            3: '24.9861571,121.3645577',
            4: '24.8545491,120.9519978',
            5: '24.6866905,120.892014',
            6: '24.5147969,120.8026139',
            7: '24.2198468,120.6756823',
            8: '23.8405937,120.7023261',
            9: '23.9919519,120.3300822',
            10: '23.6735484,120.294506',
            11: '23.4251135,120.257353',
            12: '23.1226791,120.106233',
            13: '22.6995937,120.1910021',
            14: '22.3895348,120.0680055',
            15: '22.7213708,120.6096737',
            16: '23.7330573,120.8184708',
            17: '24.648688,121.3611287',
            18: '24.4458333,118.3739224',
            19: '23.629355,119.4569846',
            20: '26.1564702,119.9239349'
        };

        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyB8uBoHMmnwYj8CBPBGyquKhZu0xCWNDmg",
            authDomain: "test-cafb0.firebaseapp.com",
            databaseURL: "https://test-cafb0.firebaseio.com",
            projectId: "test-cafb0",
            storageBucket: "test-cafb0.appspot.com",
            messagingSenderId: "31977119796"
        };
        firebase.initializeApp(config);

        function getdataAQI(i) {
            $.ajax({
                url: "http://opendata.epa.gov.tw/ws/Data/REWIQA/?$orderby=County&$skip=0&$top=1000&format=json",
                dataType: "jsonp",
                success: function(response) {
                    rgbled.setColor('#000000');
                    resultAQI = response[i].Status;
                    if (resultAQI == '良好') {
                        rgbled.setColor('#009900');
                        console.log('green')
                    } else if (resultAQI == '普通') {
                        rgbled.setColor('#ffcc66');
                        console.log('yellow')
                    } else if (resultAQI == '設備維護') {
                        rgbled.setColor('#bb00ff');
                        console.log('purple')
                    } else {
                        rgbled.setColor('#ff0000');
                        console.log('red');
                    }
                },
                error: function(response) {
                    console.log("error");
                }
            });
        }

        function show() {
            $.ajax({
                url: "http://opendata.epa.gov.tw/ws/Data/REWIQA/?$orderby=County&$skip=0&$top=1000&format=json",
                dataType: "jsonp",
                success: function(response) {
                    document.getElementById('SiteName_1').innerHTML = '測站名稱 : ' + response[53].SiteName;
                    document.getElementById('AQI_1').innerHTML = '空氣品質指標 : ' + response[53].AQI;
                    document.getElementById('Pollutant_1').innerHTML = '空氣汙染指標物 : ' + response[53].Pollutant;
                    document.getElementById('Status_1').innerHTML = '狀態 : ' + response[53].Status;
                    document.getElementById('SO2_1').innerHTML = '二氧化硫 : ' + response[53].SO2 + " ppb";
                    document.getElementById('CO_1').innerHTML = '一氧化碳 : ' + response[53].CO + ' ppm<br/>一氧化碳8hr : 0' + response[53].CO_8hr + ' ppm';
                    document.getElementById('Wind_1').innerHTML = '風向 : ' + response[53].WindDirec + ' degrees<br/> 風速 : ' + response[53].WindSpeed + ' m/sec';
                    document.getElementById('O3_1').innerHTML = '臭氧 : ' + response[53].O3 + ' ppb<br/>臭氧8hr : ' + response[53].O3_8hr + ' ppb';
                    document.getElementById('NO_1').innerHTML = 'NO指數 : ' + response[53].NO + ' ppb<br/>NO2指數 : ' + response[53].NO2 + ' ppb<br/> NOx指數 : ' + response[53].NOx + ' ppb';
                    document.getElementById('PM2.5_1').innerHTML = 'PM2.5 : ' + Object.getOwnPropertyDescriptor(response[53], "PM2.5").value + ' μg/m3<br/>PM2.5移動平均值 : ' +
                        Object.getOwnPropertyDescriptor(response[53], "PM2.5_AVG").value + ' μg/m3';
                    document.getElementById('PM10_1').innerHTML = 'PM10PM : ' + response[53].PM10 + ' μg/m3<br/>PM10移動平均值 : ' + response[53].PM10_AVG + ' μg/m3 ';
                    document.getElementById('PublishTime_1').innerHTML = '資料建置時間 : ' + response[53].PublishTime;
                },
                error: function(response) {
                    console.log("error");
                }
            });
        }

        function change() {
            sel_index = document.getElementById('select').selectedIndex;
            sel_value = document.getElementById('select').options[sel_index].value;
            if (sel_value == 0) {
                window.location.href = 'https://mokokai.tk/AQI/AQI.html';
            } else if (sel_value == 1) {
                window.location.href = 'https://mokokai.tk/AQI/AQI_Ilan.html';
            } else if (sel_value == 2) {
                window.location.href = 'https://mokokai.tk/AQI/AQI_Hualien.html';
            } else if (sel_value == 3) {
                window.location.href = 'https://mokokai.tk/AQI/AQI_Kinmen.html';
            } else if (sel_value == 4) {
                window.location.href = 'https://mokokai.tk/AQI/AQI_Nantou.html';
            } else if (sel_value == 5) {
                window.location.href = 'https://mokokai.tk/AQI/AQI_Pingtung.html';
            } else if (sel_value == 6) {
                window.location.href = 'https://mokokai.tk/AQI/AQI_Miaoli.html';
            } else if (sel_value == 7) {
                window.location.href = 'https://mokokai.tk/AQI/AQI_Taoyuan.html';
            } else if (sel_value == 8) {
                window.location.href = 'https://mokokai.tk/AQI/AQI_Kaohsiung.html';
            } else if (sel_value == 9) {
                window.location.href = 'https://mokokai.tk/AQI/AQI_Keelung.html';
            } else if (sel_value == 10) {
                window.location.href = 'https://mokokai.tk/AQI/AQI_Lianjiang.html';
            } else if (sel_value == 11) {
                window.location.href = 'https://mokokai.tk/AQI/AQI_Yunlin.html';
            } else if (sel_value == 12) {
                window.location.href = 'https://mokokai.tk/AQI/AQI_NewTaipei.html';
            } else if (sel_value == 13) {
                window.location.href = 'https://mokokai.tk/AQI/AQI_Hsinchu.html';
            } else if (sel_value == 14) {
                window.location.href = 'https://mokokai.tk/AQI/AQI_Hsinchus.html';
            } else if (sel_value == 15) {
                window.location.href = 'https://mokokai.tk/AQI/AQI_Chiayi.html';
            } else if (sel_value == 16) {
                window.location.href = 'https://mokokai.tk/AQI/AQI_Chiayis.html';
            } else if (sel_value == 17) {
                window.location.href = 'https://mokokai.tk/AQI/AQI_Changhua.html';
            } else if (sel_value == 18) {
                window.location.href = 'https://mokokai.tk/AQI/AQI_Taichung.html';
            } else if (sel_value == 19) {
                window.location.href = 'https://mokokai.tk/AQI/AQI_Taipei.html';
            } else if (sel_value == 20) {
                window.location.href = 'https://mokokai.tk/AQI/AQI_Taitung.html';
            } else if (sel_value == 21) {
                window.location.href = 'https://mokokai.tk/AQI/AQI_Tainan.html';
            } else if (sel_value == 22) {
                window.location.href = 'https://mokokai.tk/AQI/AQI_Penghu.html';
            }
        }

        boardReady({
            device: 'WGEE'
        }, function(board) {
            board.systemReset();
            board.samplingInterval = 20;
            rgbled = getRGBLed(board, 6, 8, 7);
        });

        function StartAQIsppech() {
            speak("您要查詢哪一個縣市的空氣", ["zh-TW", 1, 1, 1]);
            setTimeout(function() {
                AQIspeech()
            }, 4000);
        }

        function AQIspeech() {
            if (!("webkitSpeechRecognition" in window)) {
                alert("本瀏覽器不支援語音辨識，請更換瀏覽器！(Chrome 25 版以上才支援語音辨識)");
            } else {
                recognition = new webkitSpeechRecognition();
                window._recognition.continuous = false; //在辨識一段話完成之後就會結束辨識。
                window._recognition.interimResults = true; //在我們講話的當下就會即時辨識
                window._recognition.lang = "cmn-Hant-TW"; //語系

                window._recognition.onstart = function() {
                    console.log("Start recognize...");
                    alreadyspeech2 = true;
                };
                window._recognition.onend = function() {
                    console.log("Stop recognize");
                };

                window._recognition.onresult = function(event, result) {
                    result = {};
                    result.resultLength = event.results.length - 1;
                    result.resultTranscript = event.results[result.resultLength][0].transcript;
                    if (event.results[result.resultLength].isFinal === true) {
                        console.log(result.resultTranscript);
                        if (result.resultTranscript.indexOf("子") !== -1 && alreadyspeech2) {
                            getdataAQI(53);
                            setTimeout(function() {
                                speak('請稍後...', ["zh-TW", 1, 1, 1]);
                            }, 1000);
                            setTimeout(function() {
                                speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                            }, 6000);
                            setTimeout(function() {
                                speak(result.resultTranscript, ["zh-TW", 1, 1, 1]);
                            }, 9000);
                            setTimeout(function() {
                                speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                            }, 12000);
                            setTimeout(function() {
                                speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                console.log("2:" + resultAQI);
                            }, 16000);
                            setTimeout(function() {
                                alreadyspeech2 = false;;
                            }, 18000);
                        } else if (result.resultTranscript.indexOf("港") !== -1 && alreadyspeech2) {
                            getdataAQI(52);
                            setTimeout(function() {
                                speak('請稍後...', ["zh-TW", 1, 1, 1]);
                            }, 1000);
                            setTimeout(function() {
                                speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                            }, 6000);
                            setTimeout(function() {
                                speak(result.resultTranscript, ["zh-TW", 1, 1, 1]);
                            }, 9000);
                            setTimeout(function() {
                                speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                            }, 12000);
                            setTimeout(function() {
                                speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                console.log("2:" + resultAQI);
                            }, 16000);
                            setTimeout(function() {
                                alreadyspeech2 = false;;
                            }, 18000);
                        } else {

                            for (var i in city) {
                                while (result.resultTranscript == "台東") {
                                    result.resultTranscript = "Taitung"
                                }
                                if (result.resultTranscript.indexOf(city[i]) !== -1 && alreadyspeech2) { // 如果字串包含台灣'縣市'的話，回饋
                                    //基隆
                                    console.log(i, city[1])
                                    if (city[i] == city[1]) {
                                        getdataAQI(31);
                                        setTimeout(function() {
                                            speak('請稍後...', ["zh-TW", 1, 1, 1]);
                                        }, 1000);
                                        setTimeout(function() {
                                            speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                        }, 6000);
                                        setTimeout(function() {
                                            speak(city[i], ["zh-TW", 1, 1, 1]);
                                        }, 9000);
                                        setTimeout(function() {
                                            speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                        }, 12000);
                                        setTimeout(function() {
                                            speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                            console.log("2:" + resultAQI);
                                        }, 16000);
                                        setTimeout(function() {
                                            alreadyspeech2 = false;;
                                        }, 18000);
                                        break;
                                    } //台北
                                    else if (city[i] == city[2]) {
                                        getdataAQI(62);
                                        setTimeout(function() {
                                            speak('請稍後...', ["zh-TW", 1, 1, 1]);
                                        }, 1000);
                                        setTimeout(function() {
                                            speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                        }, 6000);
                                        setTimeout(function() {
                                            speak(city[i], ["zh-TW", 1, 1, 1]);
                                        }, 9000);
                                        setTimeout(function() {
                                            speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                        }, 12000);
                                        setTimeout(function() {
                                            speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                            console.log("2:" + resultAQI);
                                        }, 16000);
                                        setTimeout(function() {
                                            alreadyspeech2 = false;;
                                        }, 18000);
                                        break;
                                    } //新北
                                    else if (city[i] == city[3]) {
                                        getdataAQI(47);
                                        setTimeout(function() {
                                            speak('請稍後...', ["zh-TW", 1, 1, 1]);
                                        }, 1000);
                                        setTimeout(function() {
                                            speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                        }, 6000);
                                        setTimeout(function() {
                                            speak(city[i], ["zh-TW", 1, 1, 1]);
                                        }, 9000);
                                        setTimeout(function() {
                                            speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                        }, 12000);
                                        setTimeout(function() {
                                            speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                            console.log("2:" + resultAQI);
                                        }, 16000);
                                        setTimeout(function() {
                                            alreadyspeech2 = false;;
                                        }, 18000);
                                        break;
                                    } //桃園
                                    else if (city[i] == city[4]) {
                                        getdataAQI(13);
                                        setTimeout(function() {
                                            speak('請稍後...', ["zh-TW", 1, 1, 1]);
                                        }, 1000);
                                        setTimeout(function() {
                                            speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                        }, 6000);
                                        setTimeout(function() {
                                            speak(city[i], ["zh-TW", 1, 1, 1]);
                                        }, 9000);
                                        setTimeout(function() {
                                            speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                        }, 12000);
                                        setTimeout(function() {
                                            speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                            console.log("2:" + resultAQI);
                                        }, 16000);
                                        setTimeout(function() {
                                            alreadyspeech2 = false;;
                                        }, 18000);
                                        break;
                                    }
                                    //新竹
                                    else if (city[i] == city[5]) {
                                        getdataAQI(48);
                                        setTimeout(function() {
                                            speak('請稍後...', ["zh-TW", 1, 1, 1]);
                                        }, 1000);
                                        setTimeout(function() {
                                            speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                        }, 6000);
                                        setTimeout(function() {
                                            speak(city[i], ["zh-TW", 1, 1, 1]);
                                        }, 9000);
                                        setTimeout(function() {
                                            speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                        }, 12000);
                                        setTimeout(function() {
                                            speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                            console.log("2:" + resultAQI);
                                        }, 16000);
                                        setTimeout(function() {
                                            alreadyspeech2 = false;;
                                        }, 18000);
                                        break;
                                    } //苗栗
                                    else if (city[i] == city[6]) {
                                        getdataAQI(11);
                                        setTimeout(function() {
                                            speak('請稍後...', ["zh-TW", 1, 1, 1]);
                                        }, 1000);
                                        setTimeout(function() {
                                            speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                        }, 6000);
                                        setTimeout(function() {
                                            speak(city[i], ["zh-TW", 1, 1, 1]);
                                        }, 9000);
                                        setTimeout(function() {
                                            speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                        }, 12000);
                                        setTimeout(function() {
                                            speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                            console.log("2:" + resultAQI);
                                        }, 16000);
                                        setTimeout(function() {
                                            alreadyspeech2 = false;;
                                        }, 18000);
                                        break;
                                    } //台中
                                    else if (city[i] == city[7]) {
                                        getdataAQI(57);
                                        setTimeout(function() {
                                            speak('請稍後...', ["zh-TW", 1, 1, 1]);
                                        }, 1000);
                                        setTimeout(function() {
                                            speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                        }, 6000);
                                        setTimeout(function() {
                                            speak(city[i], ["zh-TW", 1, 1, 1]);
                                        }, 9000);
                                        setTimeout(function() {
                                            speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                        }, 12000);
                                        setTimeout(function() {
                                            speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                            console.log("2:" + resultAQI);
                                        }, 16000);
                                        setTimeout(function() {
                                            alreadyspeech2 = false;;
                                        }, 18000);
                                        break;
                                    } //南投
                                    else if (city[i] == city[8]) {
                                        getdataAQI(6);
                                        setTimeout(function() {
                                            speak('請稍後...', ["zh-TW", 1, 1, 1]);
                                        }, 1000);
                                        setTimeout(function() {
                                            speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                        }, 6000);
                                        setTimeout(function() {
                                            speak(city[i], ["zh-TW", 1, 1, 1]);
                                        }, 9000);
                                        setTimeout(function() {
                                            speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                        }, 12000);
                                        setTimeout(function() {
                                            speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                            console.log("2:" + resultAQI);
                                        }, 16000);
                                        setTimeout(function() {
                                            alreadyspeech2 = false;;
                                        }, 18000);
                                        break;
                                    } //彰化
                                    else if (city[i] == city[9]) {
                                        getdataAQI(54);
                                        setTimeout(function() {
                                            speak('請稍後...', ["zh-TW", 1, 1, 1]);
                                        }, 1000);
                                        setTimeout(function() {
                                            speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                        }, 6000);
                                        setTimeout(function() {
                                            speak(city[i], ["zh-TW", 1, 1, 1]);
                                        }, 9000);
                                        setTimeout(function() {
                                            speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                        }, 12000);
                                        setTimeout(function() {
                                            speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                            console.log("2:" + resultAQI);
                                        }, 16000);
                                        setTimeout(function() {
                                            alreadyspeech2 = false;;
                                        }, 18000);
                                        break;
                                    } //雲林
                                    else if (city[i] == city[10]) {
                                        getdataAQI(34);
                                        setTimeout(function() {
                                            speak('請稍後...', ["zh-TW", 1, 1, 1]);
                                        }, 1000);
                                        setTimeout(function() {
                                            speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                        }, 6000);
                                        setTimeout(function() {
                                            speak(city[i], ["zh-TW", 1, 1, 1]);
                                        }, 9000);
                                        setTimeout(function() {
                                            speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                        }, 12000);
                                        setTimeout(function() {
                                            speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                            console.log("2:" + resultAQI);
                                        }, 16000);
                                        setTimeout(function() {
                                            alreadyspeech2 = false;;
                                        }, 18000);
                                        break;
                                    } //嘉義
                                    else if (city[i] == city[11]) {
                                        getdataAQI(51);
                                        setTimeout(function() {
                                            speak('請稍後...', ["zh-TW", 1, 1, 1]);
                                        }, 1000);
                                        setTimeout(function() {
                                            speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                        }, 6000);
                                        setTimeout(function() {
                                            speak(city[i], ["zh-TW", 1, 1, 1]);
                                        }, 9000);
                                        setTimeout(function() {
                                            speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                        }, 12000);
                                        setTimeout(function() {
                                            speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                            console.log("2:" + resultAQI);
                                        }, 16000);
                                        setTimeout(function() {
                                            alreadyspeech2 = false;;
                                        }, 18000);
                                        break;
                                    } //台南
                                    else if (city[i] == city[12]) {
                                        getdataAQI(74);
                                        setTimeout(function() {
                                            speak('請稍後...', ["zh-TW", 1, 1, 1]);
                                        }, 1000);
                                        setTimeout(function() {
                                            speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                        }, 6000);
                                        setTimeout(function() {
                                            speak(city[i], ["zh-TW", 1, 1, 1]);
                                        }, 9000);
                                        setTimeout(function() {
                                            speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                        }, 12000);
                                        setTimeout(function() {
                                            speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                            console.log("2:" + resultAQI);
                                        }, 16000);
                                        setTimeout(function() {
                                            alreadyspeech2 = false;;
                                        }, 18000);
                                        break;
                                    } //高雄
                                    else if (city[i] == city[13]) {
                                        getdataAQI(27);
                                        setTimeout(function() {
                                            speak('請稍後...', ["zh-TW", 1, 1, 1]);
                                        }, 1000);
                                        setTimeout(function() {
                                            speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                        }, 6000);
                                        setTimeout(function() {
                                            speak(city[i], ["zh-TW", 1, 1, 1]);
                                        }, 9000);
                                        setTimeout(function() {
                                            speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                        }, 12000);
                                        setTimeout(function() {
                                            speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                            console.log("2:" + resultAQI);
                                        }, 16000);
                                        setTimeout(function() {
                                            alreadyspeech2 = false;;
                                        }, 18000);
                                        break;
                                    } //屏東
                                    else if (city[i] == city[14]) {
                                        getdataAQI(7);
                                        setTimeout(function() {
                                            speak('請稍後...', ["zh-TW", 1, 1, 1]);
                                        }, 1000);
                                        setTimeout(function() {
                                            speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                        }, 6000);
                                        setTimeout(function() {
                                            speak(city[i], ["zh-TW", 1, 1, 1]);
                                        }, 9000);
                                        setTimeout(function() {
                                            speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                        }, 12000);
                                        setTimeout(function() {
                                            speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                            console.log("2:" + resultAQI);
                                        }, 16000);
                                        setTimeout(function() {
                                            alreadyspeech2 = false;;
                                        }, 18000);
                                        break;
                                    } //台東
                                    else if (city[i] == city[15]) {
                                        getdataAQI(70);
                                        setTimeout(function() {
                                            speak('請稍後...', ["zh-TW", 1, 1, 1]);
                                        }, 1000);
                                        setTimeout(function() {
                                            speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                        }, 6000);
                                        setTimeout(function() {
                                            speak(city[i], ["zh-TW", 1, 1, 1]);
                                        }, 9000);
                                        setTimeout(function() {
                                            speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                        }, 12000);
                                        setTimeout(function() {
                                            speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                            console.log("2:" + resultAQI);
                                        }, 16000);
                                        setTimeout(function() {
                                            alreadyspeech2 = false;;
                                        }, 18000);
                                        break;
                                    } //花蓮
                                    else if (city[i] == city[16]) {
                                        getdataAQI(2);
                                        setTimeout(function() {
                                            speak('請稍後...', ["zh-TW", 1, 1, 1]);
                                        }, 1000);
                                        setTimeout(function() {
                                            speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                        }, 6000);
                                        setTimeout(function() {
                                            speak(city[i], ["zh-TW", 1, 1, 1]);
                                        }, 9000);
                                        setTimeout(function() {
                                            speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                        }, 12000);
                                        setTimeout(function() {
                                            speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                            console.log("2:" + resultAQI);
                                        }, 16000);
                                        setTimeout(function() {
                                            alreadyspeech2 = false;;
                                        }, 18000);
                                        break;
                                    } //宜蘭
                                    else if (city[i] == city[17]) {
                                        getdataAQI(0);
                                        setTimeout(function() {
                                            speak('請稍後...', ["zh-TW", 1, 1, 1]);
                                        }, 1000);
                                        setTimeout(function() {
                                            speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                        }, 6000);
                                        setTimeout(function() {
                                            speak(city[i], ["zh-TW", 1, 1, 1]);
                                        }, 9000);
                                        setTimeout(function() {
                                            speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                        }, 12000);
                                        setTimeout(function() {
                                            speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                            console.log("2:" + resultAQI);
                                        }, 16000);
                                        setTimeout(function() {
                                            alreadyspeech2 = false;;
                                        }, 18000);
                                        break;
                                    } //金門
                                    else if (city[i] == city[18]) {
                                        getdataAQI(3);
                                        setTimeout(function() {
                                            speak('請稍後...', ["zh-TW", 1, 1, 1]);
                                        }, 1000);
                                        setTimeout(function() {
                                            speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                        }, 6000);
                                        setTimeout(function() {
                                            speak(city[i], ["zh-TW", 1, 1, 1]);
                                        }, 9000);
                                        setTimeout(function() {
                                            speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                        }, 12000);
                                        setTimeout(function() {
                                            speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                            console.log("2:" + resultAQI);
                                        }, 16000);
                                        setTimeout(function() {
                                            alreadyspeech2 = false;;
                                        }, 18000);
                                        break;
                                    } //澎湖
                                    else if (city[i] == city[19]) {
                                        getdataAQI(75);
                                        setTimeout(function() {
                                            speak('請稍後...', ["zh-TW", 1, 1, 1]);
                                        }, 1000);
                                        setTimeout(function() {
                                            speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                        }, 6000);
                                        setTimeout(function() {
                                            speak(city[i], ["zh-TW", 1, 1, 1]);
                                        }, 9000);
                                        setTimeout(function() {
                                            speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                        }, 12000);
                                        setTimeout(function() {
                                            speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                            console.log("2:" + resultAQI);
                                        }, 16000);
                                        setTimeout(function() {
                                            alreadyspeech2 = false;;
                                        }, 18000);
                                        break;
                                    } //連江
                                    else if (city[i] == city[20]) {
                                        getdataAQI(32);
                                        setTimeout(function() {
                                            speak('請稍後...', ["zh-TW", 1, 1, 1]);
                                        }, 1000);
                                        setTimeout(function() {
                                            speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                        }, 6000);
                                        setTimeout(function() {
                                            speak(city[i], ["zh-TW", 1, 1, 1]);
                                        }, 9000);
                                        setTimeout(function() {
                                            speak('空氣品質為:', ["zh-TW", 1, 1, 1]);
                                        }, 12000);
                                        setTimeout(function() {
                                            speak(resultAQI, ["zh-TW", 1, 1, 1]);
                                            console.log("2:" + resultAQI);
                                        }, 16000);
                                        setTimeout(function() {
                                            alreadyspeech2 = false;;
                                        }, 18000);
                                        break;
                                    }
                                }
                            }
                        }
                    } else if (event.results[result.resultLength].isFinal === false) {
                        console.log("final");
                    }
                };
                if (window._recognition.start()) {
                    window._recognition.stop();
                }
                window._recognition.start();
            }
        }

        function StartAirSpeech() {
            speak("您要查詢哪一個縣市的天氣", ["zh-TW", 1, 1, 1]);
            setTimeout(function() {
                AIRspeech()
            }, 4000);
        }

        function getdata() {
            $.get(url, function(e) {
                if (e.query.count == 1) { //如果有抓到count = 1
                    mCountry = e.query.results.channel.location.country;
                    mCity = e.query.results.channel.location.city;
                    direction = e.query.results.channel.wind.direction;
                    chill = e.query.results.channel.wind.chill;
                    speed = e.query.results.channel.wind.speed;
                    humidity = e.query.results.channel.atmosphere.humidity;
                    pressure = e.query.results.channel.atmosphere.pressure;
                    rising = e.query.results.channel.atmosphere.rising;
                    visibility = e.query.results.channel.atmosphere.visibility;
                    sunrise = e.query.results.channel.astronomy.sunrise;
                    sunset = e.query.results.channel.astronomy.sunset;
                    date = e.query.results.channel.item.forecast[0].date;
                    day = e.query.results.channel.item.forecast[0].day;
                    high = e.query.results.channel.item.forecast[0].high;
                    low = e.query.results.channel.item.forecast[0].low;
                    temp = e.query.results.channel.item.condition.temp;
                    code = e.query.results.channel.item.forecast[0].code;
                    pushTime = e.query.results.channel.item.pubDate;
                    publish_time = e.query.results.channel.lastBuildDate;
                } else { //沒抓到直到抓到為止
                    getdata();
                }
            })
        }

        function AIRspeech() {
            if (!("webkitSpeechRecognition" in window)) {
                alert("本瀏覽器不支援語音辨識，請更換瀏覽器！(Chrome 25 版以上才支援語音辨識)");
            } else {

                recognition = new webkitSpeechRecognition();
                window._recognition.continuous = false; //在辨識一段話完成之後就會結束辨識。
                window._recognition.interimResults = true; //在我們講話的當下就會即時辨識
                window._recognition.lang = "cmn-Hant-TW"; //語系

                window._recognition.onstart = function() {
                    console.log("Start recognize...");
                    alreadyspeech2 = true;
                };
                window._recognition.onend = function() {
                    console.log("Stop recognize");
                };

                window._recognition.onresult = function(event, result) {
                    result = {};
                    result.resultLength = event.results.length - 1;
                    result.resultTranscript = event.results[result.resultLength][0].transcript;
                    if (event.results[result.resultLength].isFinal === true) {
                        console.log(result.resultTranscript);
                        for (var i in city) {
                            if (result.resultTranscript == "台東") {
                                result.resultTranscript = "Taitung"
                            }
                            if (result.resultTranscript.indexOf(city[i]) !== -1 && alreadyspeech2) { // 如果字串包含台灣'縣市'的話，回饋
                                url = "https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20weather.forecast%20where%20woeid%20in%20(select%20woeid%20from%20geo.places(1)%20where%20text=\"(" + citygps[i] + ")%22)&format=json&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys";
                                getdata();
                                setTimeout(function() {
                                    speak('您搜尋的位置為', ["zh-TW", 1, 1, 1]);
                                }, 3000);
                                setTimeout(function() {
                                    speak(city[i], ["zh-TW", 1, 1, 1]);
                                }, 6000);
                                setTimeout(function() {
                                    speak(['最高溫', Math.round((high - 32) * 5 / 9), '度', '最低溫', Math.round((low - 32) * 5 / 9), '度', '現在溫度', Math.round((temp - 32) * 5 / 9), '度', '濕度為', '百分之', humidity], ["zh-TW", 1, 1, 1]);
                                }, 9000);
                                setTimeout(function() {
                                    alreadyspeech2 = false;;
                                }, 25000);
                                break;
                            } else if (result.resultTranscript.indexOf(city[i]) === -1 && alreadyspeech2) {
                                setTimeout(function() {
                                    speak('請說台灣的縣市優', ["zh-TW", 1, 1, 1]);
                                }, 2000);
                                setTimeout(function() {
                                    window._recognition.start();
                                }, 4000);
                            }
                        }
                    } else if (event.results[result.resultLength].isFinal === false) {
                        console.log("final");
                    }
                };
                if (window._recognition.start()) {
                    window._recognition.stop();
                }
                window._recognition.start();
            }
        }

        function askspeech() {
            speak("請問需要什麼樣的服務呢?", ["zh-TW", 1, 1, 1]);
            setTimeout(function() {
                choosespeech()
            }, 3000);
        }

        function choosespeech() {
            if (!("webkitSpeechRecognition" in window)) {
                alert("本瀏覽器不支援語音辨識，請更換瀏覽器！(Chrome 25 版以上才支援語音辨識)");
            } else {
                window._recognition = new webkitSpeechRecognition();
                window._recognition.continuous = false; //在辨識一段話完成之後就會結束辨識。
                window._recognition.interimResults = true; //在我們講話的當下就會即時辨識
                window._recognition.lang = "cmn-Hant-TW"; //語系

                window._recognition.onstart = function() {
                    console.log("Start recognize...");
                    alreadyspeech = true;
                };

                window._recognition.onend = function() {
                    console.log("Stop recognize");
                };


                window._recognition.onresult = function(event, result) {
                    result = {};
                    result.resultLength = event.results.length - 1;
                    result.resultTranscript = event.results[result.resultLength][0].transcript;
                    if (event.results[result.resultLength].isFinal === true) {
                        console.log(result.resultTranscript);
                        if (result.resultTranscript.indexOf("天氣") !== -1 || result.resultTranscript.indexOf("空氣") !== -1) {
                            if (result.resultTranscript.indexOf("天氣") !== -1) {
                                StartAirSpeech();
                                AIRspeech();
                            } else if (result.resultTranscript.indexOf("空氣") !== -1) {
                                StartAQIsppech();
                                AQIspeech();
                            }
                        } else {
                            if (result.resultTranscript.indexOf("活動") !== -1) {
                                setTimeout(function() {
                                    console.log(document.getElementById('Status_1').innerHTML.split(' : ')[1]);
                                    if (document.getElementById('Status_1').innerHTML.split(' : ')[1] == '良好') {
                                        speak('沒事多出門，多出門沒事', ["zh-TW", 1, 1, 1]);
                                        console.log('green')
                                    } else if (document.getElementById('Status_1').innerHTML.split(' : ')[1] == '普通') {
                                        speak('建議如果要騎車，可以戴個口罩', ["zh-TW", 1, 1, 1]);
                                        console.log('yellow')
                                    } else if (document.getElementById('Status_1').innerHTML.split(' : ')[1] == '設備維護') {
                                        speak('設備維護中!', ["zh-TW", 1, 1, 1]);
                                        console.log('purple')
                                    } else {
                                        speak('外面空氣粉差，沒事不要出門', ["zh-TW", 1, 1, 1]);
                                        console.log('red');
                                    }
                                }, 2000);
                            } else if (result.resultTranscript.indexOf("你好") !== -1) {
                                speak('你好，我是空汙小幫手', ["zh-TW", 1, 1, 1]);
                                console.log('你好');
                            } else if (result.resultTranscript.indexOf("自我介紹") !== -1) {
                                speak('我不要!', ["zh-TW", 1, 1, 1]);
                            } else if (result.resultTranscript.indexOf("跳舞") !== -1) {
                                speak('我沒有手跟腳!', ["zh-TW", 1, 1, 1]);
                            } else if (result.resultTranscript.indexOf("功能") !== -1) {
                                speak('我可以查詢即時天氣以及空氣品質', ["zh-TW", 1, 1, 1]);
                                console.log('功能');
                            } else if (result.resultTranscript.indexOf("幾歲") !== -1) {
                                speak('18歲', ["zh-TW", 1, 1, 1]);
                            } else if (result.resultTranscript.indexOf("拜拜") !== -1) {
                                speak('主人下次見', ["zh-TW", 1, 1, 1]);
                                console.log('拜拜');
                            } else if (result.resultTranscript.indexOf("沒事") !== -1) {
                                speak('如果還需要我，請在呼喚我優', ["zh-TW", 1, 1, 1]);
                                console.log('沒事');
                            } else if (result.resultTranscript.indexOf("笑話") !== -1) {
                                speak('一切都是假的，眼睛業障重，啊!我沒有眼睛。哈哈', ["zh-TW", 1, 1, 1]);
                                console.log('哈哈');
                            } else if (result.resultTranscript.indexOf("我愛你") !== -1) {
                                speak('主人，不好意思，人機戀是不允許的喔。', ["zh-TW", 1, 1, 1]);
                                console.log('愛你');
                            } else if (result.resultTranscript.indexOf("日期") !== -1) {
                                gettime();
                                speak(['現在日期', y, '年', mo, '月', d, '日'], ["zh-TW", 1, 1, 1]);
                                console.log('date');
                            } else if (result.resultTranscript.indexOf("時間") !== -1) {
                                gettime();
                                speak(['現在時間', h, '點', m, '分', s, '秒'], ["zh-TW", 1, 1, 1]);
                                console.log('time');
                            } else {
                                speak('抱歉，沒有這個功能', ["zh-TW", 1, 1, 1]);
                            }
                        }
                    } else if (event.results[result.resultLength].isFinal === false) {
                        console.log("final");
                    }
                };
                if (window._recognition.start()) {
                    window._recognition.stop();
                }
                window._recognition.start();
            }
        }
    </script>

    <style>
        body {
            background-size: 100% auto;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }
        
        p {
            size: 150%;
            color: white;
        }
        
        h1,
        h5 {
            width: 20%;
            background-color: black;
            color: white;
            opacity: 0.6;
        }
    </style>
</head>

<body onload="change_background();show();">
    <!-- 項目列表開始 -->
    <div class="container">
        <div class="row new-icons">
            <div class="row">
                <div class="col-xs-6 col-sm-6">
                    <div class="thumbnail text-center" style="padding:15px;background-color:black;opacity:0.6;" CellSpacing="8" CellPadding="8">
                        <img src='https://mokokai.tk/OpenWeatherSide/img/home.png' onclick="backtohome();" width='40' height="40"></img>
                        <center>
                            <font color='white'>
                                目前位置<br>嘉義 朴子
                            </font>
                        </center>
                        <div class='caption'>
                            <button id='ask' onclick="askspeech();">詢問</button>
                        </div>
                    </div>
                </div>
                <div class="col-xs-6 col-sm-6">
                    <div class="thumbnail text-center" style="padding:15px;background-color:black;opacity:0.6;" CellSpacing="8" CellPadding="8">
                        <center>
                            <br>
                            <font color='white'>
                                <h3>請選擇城市</h3>
                            </font>
                        </center>
                        <div class="caption">
                            <form id='form1' align='center' name='form1'>
                                <select id='select' onchange="change()">
                                    <option value="0" selected="true">請選取城市</option>
                                    <option value="1">宜蘭縣</option>
                                    <option value="2">花蓮縣</option>
                                    <option value="3">金門縣</option>
                                    <option value="4">南投縣</option>
                                    <option value="5">屏東縣</option>
                                    <option value="6">苗栗縣</option>
                                    <option value="7">桃園市</option>
                                    <option value="8">高雄市</option>
                                    <option value="9">基隆市</option>
                                    <option value="10">連江縣</option>
                                    <option value="11">雲林縣</option>
                                    <option value="12">新北市</option>
                                    <option value="13">新竹市</option>
                                    <option value="14">新竹縣</option>
                                    <option value="15">嘉義市</option>
                                    <option value="16">嘉義縣</option>
                                    <option value="17">彰化縣</option>
                                    <option value="18">臺中市</option>
                                    <option value="19">臺北市</option>
                                    <option value="20">臺東縣</option>
                                    <option value="21">臺南市</option>
                                    <option value="22">澎湖縣</option>
                                </select>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-12">
                    <div class="thumbnail text-center" style="padding:15px;background-color:black;opacity:0.6;" CellSpacing="8" CellPadding="8">
                        <div class="caption">
                            <center>
                                <iframe src="https://plotdb.io/v/chart/14112" width="100%" height="600px" allowfullscreen="true" frameborder="0"></iframe>
                            </center>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-12">
                    <div class="thumbnail text-center" style="padding:15px;background-color:black;opacity:0.6;" CellSpacing="8" CellPadding="8">
                        <div class="caption">
                            <p align="center" id='SiteName_1'></p>
                            <p align="center" id='AQI_1'></p>
                            <p align="center" id='Pollutant_1'></p>
                            <p align="center" id='Status_1'></p>
                            <p align="center" id='SO2_1'></p>
                            <p align="center" id='CO_1'></p>
                            <p align="center" id='Wind_1'></p>
                            <p align="center" id='O3_1'></p>
                            <p align="center" id='NO_1'></p>
                            <p align="center" id='PM2.5_1'></p>
                            <p align="center" id='PM10_1'></p>
                            <p align="center" id='PublishTime_1'></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

</body>

</html>